<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML DIR="LTR"><HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<TITLE>How NDIS Sets the Power Policy for a NIC</TITLE>
<SCRIPT SRC="../scripts/linkcss.js"></SCRIPT><SCRIPT SRC="../scripts/langref.js"></SCRIPT><META NAME="MS-HKWD" CONTENT="How NDIS Sets the Power Policy for a NIC">
</HEAD>
<BODY TOPMARGIN="0">
<DIV STYLE="display:none;">
<OBJECT ID="hhobj_1" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink,MENU">
	<PARAM NAME="DefaultTopic" VALUE="../notopic_0pk4.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="ddk_managing_device_power_policy_kg">
</OBJECT>
<OBJECT ID="hhobj_2" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink,MENU">
	<PARAM NAME="DefaultTopic" VALUE="../notopic_0pk4.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="ddk_device_capabilities_dr">
</OBJECT>
<OBJECT ID="hhobj_3" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink,MENU">
	<PARAM NAME="DefaultTopic" VALUE="../notopic_0pk4.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="ddk_irp_mn_query_capabilities_dr">
</OBJECT>
<OBJECT ID="hhobj_4" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink,MENU">
	<PARAM NAME="DefaultTopic" VALUE="../notopic_0pk4.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="ddk_irp_mn_query_capabilities_dr">
</OBJECT>
<OBJECT ID="hhobj_5" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink,MENU">
	<PARAM NAME="DefaultTopic" VALUE="../notopic_0pk4.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="ddk_device_capabilities_dr">
</OBJECT>
<OBJECT ID="hhobj_6" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink,MENU">
	<PARAM NAME="DefaultTopic" VALUE="../notopic_0pk4.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="ddk_deviced1_and_deviced2_kg">
</OBJECT>
<OBJECT ID="hhobj_7" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink,MENU">
	<PARAM NAME="DefaultTopic" VALUE="../notopic_0pk4.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="ddk_deviced1_and_deviced2_kg">
</OBJECT>
<OBJECT ID="hhobj_8" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink,MENU">
	<PARAM NAME="DefaultTopic" VALUE="../notopic_0pk4.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="ddk_wakefromd0_wakefromd1_wakefromd2_and_wakefromd3_kg">
</OBJECT>
<OBJECT ID="hhobj_9" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink,MENU">
	<PARAM NAME="DefaultTopic" VALUE="../notopic_0pk4.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="ddk_wakefromd0_wakefromd1_wakefromd2_and_wakefromd3_kg">
</OBJECT>
<OBJECT ID="hhobj_10" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink,MENU">
	<PARAM NAME="DefaultTopic" VALUE="../notopic_0pk4.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="ddk_wakefromd0_wakefromd1_wakefromd2_and_wakefromd3_kg">
</OBJECT>
<OBJECT ID="hhobj_11" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink,MENU">
	<PARAM NAME="DefaultTopic" VALUE="../notopic_0pk4.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="ddk_wakefromd0_wakefromd1_wakefromd2_and_wakefromd3_kg">
</OBJECT>
<OBJECT ID="hhobj_12" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink,MENU">
	<PARAM NAME="DefaultTopic" VALUE="../notopic_0pk4.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="ddk_devicestate_kg">
</OBJECT>
<OBJECT ID="hhobj_13" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink,MENU">
	<PARAM NAME="DefaultTopic" VALUE="../notopic_0pk4.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="ddk_systemwake_kg">
</OBJECT>
<OBJECT ID="hhobj_14" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink,MENU">
	<PARAM NAME="DefaultTopic" VALUE="../notopic_0pk4.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="ddk_devicewake_kg">
</OBJECT>
<OBJECT ID="hhobj_15" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink,MENU">
	<PARAM NAME="DefaultTopic" VALUE="../notopic_0pk4.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="ddk_device_capabilities_dr">
</OBJECT>
</DIV>


<TABLE CLASS="buttonbarshade" CELLSPACING=0><TR><TD>&nbsp;</TD></TR></TABLE>
<TABLE CLASS="buttonbartable" CELLSPACING=0>
<TR ID="hdr"><TD CLASS="runninghead" NOWRAP>Network&nbsp;Devices&nbsp;and&nbsp;Protocols:&nbsp;Windows&nbsp;DDK</TD></TR>
</TABLE>
<H1><A NAME="ddk_how_ndis_sets_the_power_policy_for_a_nic_ng"></A>How NDIS Sets the Power Policy for a NIC</H1>

<P>NDIS serves as the device power policy owner for each network device. As such, NDIS sets and administers the power policy for each network device. For more information on managing device power policy, see <A HREF="JavaScript:hhobj_1.Click()">Managing Device Power Policy</A>.</P>

<P>NDIS uses the following information to set the power policy for a NIC:

<UL>
	<LI>The <A HREF="JavaScript:hhobj_2.Click()">DEVICE_CAPABILITIES</A> structure returned by the bus driver in response to an <A HREF="JavaScript:hhobj_3.Click()">IRP_MN_QUERY_CAPABILITIES</A> request issued by NDIS.</LI>

	<LI>The miniport driver's response to an <A HREF="212pnpoid_5j02.htm">OID_PNP_CAPABILITIES</A> request issued by NDIS.</LI>

	<LI>User input from the user interface (UI).</LI>
</UL>

<H4>Using the DEVICE_CAPABILITIES Structure</H4>

<P>When a NIC is enumerated, NDIS queries the NIC's capabilities by issuing, in addition to other requests, an <A HREF="JavaScript:hhobj_4.Click()">IRP_MN_QUERY_CAPABILITIES</A>request. In response to this request, the bus driver returns a <A HREF="JavaScript:hhobj_5.Click()">DEVICE_CAPABILITIES</A> structure. NDIS copies this structure and uses the following information from this structure when setting the power policy for the NIC.</P>

<TABLE>

<TR VALIGN="top">
<TH align=left width=48%>Member</TH>
<TH align=left width=52%>Description</TH>
</TR>

<TR VALIGN="top">
<TD width=48%><A HREF="JavaScript:hhobj_6.Click()"><B>DeviceD1</B></A></TD>
<TD width=52%>TRUE if the device supports the D1 power state.</TD>
</TR>

<TR VALIGN="top">
<TD width=48%><A HREF="JavaScript:hhobj_7.Click()"><B>DeviceD2</B></A></TD>
<TD width=52%>TRUE if the device supports the D2 power state.</TD>
</TR>

<TR VALIGN="top">
<TD width=48%><A HREF="JavaScript:hhobj_8.Click()"><B>WakeFromD0</B></A></TD>
<TD width=52%>TRUE if the device can respond to an external wake signal while in the D0 power state.</TD>
</TR>

<TR VALIGN="top">
<TD width=48%><A HREF="JavaScript:hhobj_9.Click()"><B>WakeFromD1</B></A></TD>
<TD width=52%>TRUE if the device can respond to an external wake signal while in the D1 power state.</TD>
</TR>

<TR VALIGN="top">
<TD width=48%><A HREF="JavaScript:hhobj_10.Click()"><B>WakeFromD2</B></A></TD>
<TD width=52%>TRUE if the device can respond to an external wake signal while in the D2 power state.</TD>
</TR>

<TR VALIGN="top">
<TD width=48%><A HREF="JavaScript:hhobj_11.Click()"><B>WakeFromD3</B></A></TD>
<TD width=52%>TRUE if the device can respond to an external wake signal while in the D3 power state.</TD>
</TR>

<TR VALIGN="top">
<TD width=48%><A HREF="JavaScript:hhobj_12.Click()"><B>DeviceState</B></A><B>[PowerSystemMaximum]</B></TD>
<TD width=52%>Specifies the highest-powered device state that this device can maintain for each system power state, from <B>PowerSystemUnspecified</B> to <B>PowerSystemShutdown</B>.</TD>
</TR>

<TR VALIGN="top">
<TD width=48%><A HREF="JavaScript:hhobj_13.Click()"><B>SystemWake</B></A></TD>
<TD width=52%>Specifies lowest-powered system power state (S0 through S4) from which the device can signal a wake event.</TD>
</TR>

<TR VALIGN="top">
<TD width=48%><A HREF="JavaScript:hhobj_14.Click()"><B>DeviceWake</B></A></TD>
<TD width=52%>Specifies lowest-powered device power state (D0 through D3) from which the device can signal a wake event.</TD>
</TR>
</TABLE><BR>

<P>NDIS uses the DEVICE_CAPABILITIES information to answer the following questions:

<UL>
	<LI>Do both the system and the NIC support power management? If so, which device power states can the NIC be in for each system power state?</LI>

	<LI>Do both the system and the NIC support wake-on-LAN? If so, from which device power states can the NIC wake the system?</LI>
</UL>

<P><B>WakeFromD0</B> through <B>WakeFromD3</B> indicate the device power states from which the NIC can wake the system.</P>

<P>The <B>DeviceState</B> array indicates, for each system power state, the highest-powered device power state in which the NIC can be and still support that system power state. For example, consider the following array values:</P>

<P class=indent1><B>DeviceState[PowerSystemWorking] PowerDeviceD0 DeviceState[PowerSystemSleeping1] PowerDeviceD1 DeviceState[PowerSystemSleeping2] PowerDeviceD2 DeviceState[PowerSystemSleeping3] PowerDeviceD2 DeviceState[PowerSystemHibernate] PowerDeviceD3 DeviceState[PowerSystemShutdown] PowerDeviceD3</B></P>

<P>As indicated by this array of sample values, when the system is in system power state S1, the NIC can be in device power state D1, D2, or D3. When the system is in system power state S2 or S3, the NIC can be in device power state D2 or D3.</P>

<P>To determine whether both the system and NIC support wake-on-LAN, NDIS examines both the <B>SystemWake</B> and <B>DeviceWake</B> members. If both <B>SystemWake</B> and <B>DeviceWake</B> are set to <B>PowerSystemUnspecified</B>, NDIS treats the NIC as capable of power management. In this case, or if the miniport driver set the NDIS_ATTRIBUTE_NO_HALT_ON_SUSPEND flag during initialization, NDIS subsequently issues the miniport driver an <A HREF="212pnpoid_5j02.htm">OID_PNP_CAPABILITIES</A> request to obtain more information about the NIC's wake-up capabilities. </P>

<H4>Using OID_PNP_CAPABILITIES</H4>

<P>After a miniport driver successfully returns from its <A HREF="101mini_9jzm.htm"><I>MiniportInitialize</I></A> function, NDIS sends an OID_PNP_CAPABILITIES request to the driver if either of the following is true:

<UL>
	<LI>Both the <B>SystemWake</B> and <B>DeviceWake</B> members of the <A HREF="JavaScript:hhobj_15.Click()">DEVICE_CAPABILITIES</A>structure returned by the bus driver are <U>not</U> set to <B>PowerSystemUnspecified</B>.</LI>

	<LI>The miniport driver set the NDIS_ATTRIBUTE_NO_HALT_ON_SUSPEND flag when it called <A HREF="103ndisx_1pmb.htm"><B>NdisMSetAttributesEx</B></A> during initialization.</LI>
</UL>

<P>Note that NDIS issues an OID_PNP_CAPABILITIES request regardless of whether the user has enabled wake-on-LAN in the user interface.</P>

<P>If the miniport driver returns NDIS_STATUS_SUCCESS in response to a query of <A HREF="212pnpoid_5j02.htm">OID_PNP_CAPABILITIES</A>, NDIS treats the miniport driver as PM-capable. If the miniport driver returns NDIS_STATUS_NOT_SUPPORTED, NDIS treats the miniport driver as a legacy miniport driver that is not PM-capable. See <A HREF="206pm_3q3r.htm">Power Management for Legacy Miniport Drivers</A> for more information. </P>

<P>A miniport driver that succeeds an OID_PNP_CAPABILITIES request returns to NDIS the following information in response to the request:

<UL>
	<LI>The lowest device power state from which the NIC can wake the system on receipt of a Magic Packet.</LI>

	<LI>The lowest device power state from which the NIC can wake the system on receipt of a network frame that contains a pattern specified by the protocol driver.</LI>
</UL>

<P>As soon as NDIS gets this information, it determines, for each system power state, the device power states to which it can set the NIC if wake-on-LAN is enabled by the user in the UI. If there are no allowable low-power device states from which the NIC can generate a wake-up signal (that is, if all the low-power device power states specified in the <B>DeviceState</B> array of DEVICE_CAPABILITIES structures are lower than lowest device power states from which the NIC can wake the system), NDIS shades the <B>Allow the device to bring the computer out of standby</B> check box in the <B>Power Management</B> tab for the NIC. This prevents the user from enabling wake-on-LAN.</P>

<P class=note><B>Note</B>&nbsp;&nbsp;Wake-on-LAN is possible only if both the NIC and the system are PM-capable. If the system is not PM-capable, NDIS will not query a NIC's power management capabilities.</P>

<H4>Using User Input</H4>

<P>For a PM-capable NIC, Microsoft® Windows®&nbsp;2000 and Windows Millennium Edition (Me) provide the following check boxes in the <B>Power Management</B> tab of a NIC's <B>Properties</B> dialog box:</P>

<P class=indent1><B>Allow the computer to turn off this device to save power</B></P>

<P class=indent1><B>Allow the device to bring the computer out of standby</B></P>

<P>The first check box is selected by default, thereby enabling power management for the NIC. If the user clears the check box, NDIS treats the NIC as a legacy NIC with regard to power management. For more information, see <A HREF="206pm_3q3r.htm">Power Management for Legacy Miniport Drivers</A>.</P>

<P>The second check box is clear by default. If NDIS determines that there is no allowable low-power state from which the NIC can generate a wake-up signal, NDIS makes the second check box unavailable. For example, if the <B>DeviceState</B> array member of the DEVICE_CAPABILITIES structure indicates that the NIC must be in D3 for all low-power system states, and if <B>DeviceWake</B> indicates that the lowest-powered device state from which the NIC can wake the system is D2, then NDIS shades makes the second check box unavailable.</P>

<P>In addition to the above two check boxes, Windows XP provides a third checkbox on the <B>Power Management</B> tab for a NIC:</P>

<P class=indent1><B>Only allow management stations to bring the computer out of standby</B></P>

<P>This check box, which is subordinate to the second check box described earlier, is available only if:

<UL>
	<LI>The user selected the second check box in order to enable wake-on-LAN.</LI>

	<LI>The miniport driver, in responding to the <A HREF="212pnpoid_5j02.htm">OID_PNP_CAPABILITIES</A>, indicated that the NIC could wake the system on receipt of a Magic Packet.</LI>
</UL>

<P>This check box is clear by default. The user can select this check box to specify that only the receipt of a Magic Packet will cause the NIC to generate a wake-up signal to the system.</P>

<P>Whenever a user selects or clears a power management check box for a NIC, the system notifies NDIS of the change. NDIS writes the new setting to the registry so that the changed setting persists across reboots.</P>
<DIV CLASS="footer"><A HREF="mailto:ddksurv1@microsoft.com?subject=DDK Topic Feedback&body=Build date: Thursday, January 16, 2003     Topic Title: How%20NDIS%20Sets%20the%20Power%20Policy%20for%20a%20NIC"> Send feedback on this topic.</A> / Built on Thursday, January 16, 2003 </DIV>
</BODY>
</HTML>
